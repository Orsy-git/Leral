{% extends "base.html" %}

{% block content %}
<div class="dashboard-container">
    <div class="page-header">
        <a href="/dashboard?meter_id={{ meter_id }}" class="back-btn">
            <i class="fas fa-arrow-left"></i>
            Retour au tableau de bord
        </a>
        <h1>Historique Complet</h1>
        <p>Consultez l'historique détaillé de votre consommation</p>
    </div>

    <div class="history-grid">
        <div class="history-card">
            <div class="history-header">
                <h3><i class="fas fa-chart-line"></i> Historique Quotidien (30 jours)</h3>
                <button class="btn-outline" onclick="exportToExcel()">
                    <i class="fas fa-download"></i> Exporter CSV
                </button>
            </div>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Consommation (kWh)</th>
                            <th>Coût (FCFA)</th>
                            <th>Statut</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for day in meter_data.daily_data %}
                        <tr>
                            <td>{{ day.date }}</td>
                            <td>{{ "%.2f"|format(day.consumption_kwh) }} kWh</td>
                            <td>{{ "%.2f"|format(day.cost) }} FCFA</td>
                            <td>
                                <span class="status-badge {{ 'normal' if day.consumption_kwh < 35 else 'high' }}">
                                    {{ 'Normal' if day.consumption_kwh < 35 else 'Élevé' }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="history-card">
            <div class="history-header">
                <h3><i class="fas fa-calendar-alt"></i> Historique Mensuel</h3>
            </div>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Mois</th>
                            <th>Consommation (kWh)</th>
                            <th>Coût (FCFA)</th>
                            <th>Tendance</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for month in meter_data.monthly_data %}
                        <tr>
                            <td>{{ month.month }}</td>
                            <td>{{ "%.2f"|format(month.consumption_kwh) }} kWh</td>
                            <td>{{ "%.2f"|format(month.cost) }} FCFA</td>
                            <td>
                                <i class="fas fa-arrow-{{ 'up' if month.consumption_kwh > 800 else 'down' }} 
                                    {{ 'success' if month.consumption_kwh <= 800 else 'warning' }}"></i>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="stats-summary">
        <div class="stat-item">
            <h4>Consommation Moyenne Quotidienne</h4>
            <div class="stat-value">
                {{ "%.2f"|format((meter_data.daily_data | map(attribute='consumption_kwh') | list | sum) / (meter_data.daily_data | length)) }} kWh
            </div>
        </div>
        <div class="stat-item">
            <h4>Coût Mensuel Moyen</h4>
            <div class="stat-value">
                {{ "%.2f"|format((meter_data.monthly_data | map(attribute='cost') | list | sum) / (meter_data.monthly_data | length)) }} FCFA
            </div>
        </div>
        <div class="stat-item">
            <h4>Jours à Consommation Élevée</h4>
            <div class="stat-value">
                {{ meter_data.daily_data | selectattr('consumption_kwh', 'gt', 35) | list | count }}
            </div>
        </div>
    </div>
</div>

<script>
function exportToExcel() {
    window.location.href = '/api/export_excel';
}
</script>
{% endblock %}